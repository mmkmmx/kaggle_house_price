---
title: "final_project"
author: "Mike Marett, Craig Teerlink, Belu Chik"
output: html_document
---
## Useful Resources
https://www.kaggle.com/erikbruin/house-prices-lasso-xgboost-and-a-detailed-eda



## SETUP
```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(caret)

```

## Download and inspect data

```{r}

d1 <- read_csv("train.csv")
dtest <- read_csv("test.csv")

# rename the three illegally named variables (1stflrSF, 2ndFlrSF, 3SsnPorch) 

colnames(d1) <- c("Id",            "MSSubClass",    "MSZoning" ,     "LotFrontage",   "LotArea",       "Street",        "Alley",         "LotShape", "LandContour" ,  "Utilities" ,    "LotConfig",     "LandSlope",     "Neighborhood",  "Condition1",    "Condition2",    "BldgType", "HouseStyle" ,   "OverallQual",   "OverallCond",   "YearBuilt"    , "YearRemodAdd" , "RoofStyle",     "RoofMatl",      "Exterior1st", "Exterior2nd",   "MasVnrType",    "MasVnrArea",    "ExterQual",     "ExterCond",     "Foundation",    "BsmtQual",      "BsmtCond","BsmtExposure",  "BsmtFinType1",  "BsmtFinSF1",    "BsmtFinType2",  "BsmtFinSF2",    "BsmtUnfSF",     "TotalBsmtSF" ,  "Heating", "HeatingQC",     "CentralAir" ,   "Electrical"   , "FirstFlrSF" ,     "SecondFlrSF" ,     "LowQualFinSF",  "GrLivArea",     "BsmtFullBath",  "BsmtHalfBath",  "FullBath",      "HalfBath",      "BedroomAbvGr",  "KitchenAbvGr",  "KitchenQual",   "TotRmsAbvGrd",  "Functional",   
"Fireplaces",    "FireplaceQu",   "GarageType",    "GarageYrBlt",   "GarageFinish",  "GarageCars",    "GarageArea",    "GarageQual",   
"GarageCond",    "PavedDrive",    "WoodDeckSF",    "OpenPorchSF",   "EnclosedPorch", "ThreeSsnPorch",     "ScreenPorch",   "PoolArea",      "PoolQC",        "Fence"       ,  "MiscFeature",   "MiscVal"     ,  "MoSold"  ,      "YrSold"  ,      "SaleType"    ,  "SaleCondition", "SalePrice")

# same thing for dtest (minus sales price)

colnames(dtest) <- c("Id",            "MSSubClass",    "MSZoning" ,     "LotFrontage",   "LotArea",       "Street",        "Alley",         "LotShape", "LandContour" ,  "Utilities" ,    "LotConfig",     "LandSlope",     "Neighborhood",  "Condition1",    "Condition2",    "BldgType", "HouseStyle" ,   "OverallQual",   "OverallCond",   "YearBuilt"    , "YearRemodAdd" , "RoofStyle",     "RoofMatl",      "Exterior1st", "Exterior2nd",   "MasVnrType",    "MasVnrArea",    "ExterQual",     "ExterCond",     "Foundation",    "BsmtQual",      "BsmtCond","BsmtExposure",  "BsmtFinType1",  "BsmtFinSF1",    "BsmtFinType2",  "BsmtFinSF2",    "BsmtUnfSF",     "TotalBsmtSF" ,  "Heating", "HeatingQC",     "CentralAir" ,   "Electrical"   , "FirstFlrSF" ,     "SecondFlrSF" ,     "LowQualFinSF",  "GrLivArea",     "BsmtFullBath",  "BsmtHalfBath",  "FullBath",      "HalfBath",      "BedroomAbvGr",  "KitchenAbvGr",  "KitchenQual",   "TotRmsAbvGrd",  "Functional",   
"Fireplaces",    "FireplaceQu",   "GarageType",    "GarageYrBlt",   "GarageFinish",  "GarageCars",    "GarageArea",    "GarageQual",   
"GarageCond",    "PavedDrive",    "WoodDeckSF",    "OpenPorchSF",   "EnclosedPorch", "ThreeSsnPorch",     "ScreenPorch",   "PoolArea",      "PoolQC",        "Fence"       ,  "MiscFeature",   "MiscVal"     ,  "MoSold"  ,      "YrSold"  ,      "SaleType"    ,  "SaleCondition")

#colnames(d1) == colnames(dtest)

```

## CLEANUP
### Data issue 1: NAs 

    + NAs.  If there are missing values among the test set predictors, predict() will produce an NA.  Kaggle won't like that! *Stop and think*:  have you coded the NAs appropriately? For example, `alley` has a bunch of NAs, but in that case NA does not mean missing data but instead means: no alley.  The appropriate action is to recode NAs in `alley` as "none."

```{r}

# show NA counts for all variables, use test dataset for counts, but assign same solution to both datasets
#dtest %>% 
#  mutate_all(.funs = is.na) %>% 
#  summarize_all(.funs = sum) %>%
#  t()

# see what each variable looks like, one at a time:
#table(d1$Electrical)
#table(dtest$Electrical)

# For categorical variables, we will replace NAs with 'none'
#
#    Categorical variables...
# Alley:        1352  categorical - replace NAs with 'none'
# Utilities:       2  categorical - replace NAs with 'none' 
# Exterior1st:     1  categorical - replace NAs with 'none' 
# Exterior2nd:     1  categorical - replace NAs with 'none'
# MasVnrType:     16  categorical - replace NAs with 'none'
# BsmtQual        44  categorical - replace NAs with 'none'
# BsmtCond        45  categorical - replace NAs with 'none'
# BsmtExposure    44  categorical - replace NAs with 'none'
# BsmtFinType1    42  categorical - replace NAs with 'none'
# BsmtFinType2    42  categorical - replace NAs with 'none'
# KitchenQual      1  categorical - replace NAs with 'none'
# Functional       2  categorical - replace NAs with 'none'
# FireplaceQu    730  categorical - replace NAs with 'none'
# GarageType      76  categorical - replace NAs with 'none'
# GarageFinish    78  categorical - replace NAs with 'none'
# GarageQual      78  categorical - replace NAs with 'none'
# GarageCond      78  categorical - replace NAs with 'none'
# PoolQC        1456  categorical - replace NAs with 'none'
# Fence         1169  categorical - replace NAs with 'none'
# MiscFeature   1408  categorical - replace NAs with 'none'
# SaleType         1  categorical - replace NAs with 'none'
# MSZoning         4  categorical - replace NAs with 'none'

dtest <- dtest %>%
  mutate(Alley = ifelse(is.na(Alley), "none", Alley),
         Utilities = ifelse(is.na(Utilities),"none",Utilities),
         Exterior1st = ifelse(is.na(Exterior1st),"none",Exterior1st),
         Exterior2nd = ifelse(is.na(Exterior2nd),"none",Exterior2nd),
         MasVnrType = ifelse(is.na(MasVnrType),"none",MasVnrType),
         BsmtQual = ifelse(is.na(BsmtQual),"none",BsmtQual),
         BsmtCond = ifelse(is.na(BsmtCond),"none",BsmtCond),
         BsmtExposure = ifelse(is.na(BsmtExposure),"none",BsmtExposure),
         BsmtFinType1 = ifelse(is.na(BsmtFinType1),"none",BsmtFinType1),
         BsmtFinType2 = ifelse(is.na(BsmtFinType2),"none",BsmtFinType2),
         KitchenQual = ifelse(is.na(KitchenQual),"none",KitchenQual),
         Functional = ifelse(is.na(Functional),"none",Functional),
         FireplaceQu = ifelse(is.na(FireplaceQu),"none",FireplaceQu),
         GarageType = ifelse(is.na(GarageType),"none",GarageType),
         GarageFinish = ifelse(is.na(GarageFinish),"none",GarageFinish),
         GarageQual = ifelse(is.na(GarageQual),"none",GarageQual),
         GarageCond = ifelse(is.na(GarageCond),"none",GarageCond),
         PoolQC = ifelse(is.na(PoolQC),"none",PoolQC),
         Fence = ifelse(is.na(Fence),"none",Fence),
         MiscFeature = ifelse(is.na(MiscFeature),"none",MiscFeature),
         SaleType = ifelse(is.na(SaleType),"none",SaleType),
         MSZoning = ifelse(is.na(MSZoning),"none",MSZoning),
         Electrical = ifelse(is.na(Electrical),"none",Electrical))
         
d1 <- d1 %>%
  mutate(Alley = ifelse(is.na(Alley), "none", Alley),
         Utilities = ifelse(is.na(Utilities),"none",Utilities),
         Exterior1st = ifelse(is.na(Exterior1st),"none",Exterior1st),
         Exterior2nd = ifelse(is.na(Exterior2nd),"none",Exterior2nd),
         MasVnrType = ifelse(is.na(MasVnrType),"none",MasVnrType),
         BsmtQual = ifelse(is.na(BsmtQual),"none",BsmtQual),
         BsmtCond = ifelse(is.na(BsmtCond),"none",BsmtCond),
         BsmtExposure = ifelse(is.na(BsmtExposure),"none",BsmtExposure),
         BsmtFinType1 = ifelse(is.na(BsmtFinType1),"none",BsmtFinType1),
         BsmtFinType2 = ifelse(is.na(BsmtFinType2),"none",BsmtFinType2),
         KitchenQual = ifelse(is.na(KitchenQual),"none",KitchenQual),
         Functional = ifelse(is.na(Functional),"none",Functional),
         FireplaceQu = ifelse(is.na(FireplaceQu),"none",FireplaceQu),
         GarageType = ifelse(is.na(GarageType),"none",GarageType),
         GarageFinish = ifelse(is.na(GarageFinish),"none",GarageFinish),
         GarageQual = ifelse(is.na(GarageQual),"none",GarageQual),
         GarageCond = ifelse(is.na(GarageCond),"none",GarageCond),
         PoolQC = ifelse(is.na(PoolQC),"none",PoolQC),
         Fence = ifelse(is.na(Fence),"none",Fence),
         MiscFeature = ifelse(is.na(MiscFeature),"none",MiscFeature),
         SaleType = ifelse(is.na(SaleType),"none",SaleType),
         MSZoning = ifelse(is.na(MSZoning),"none",MSZoning),
         Electrical = ifelse(is.na(Electrical),"none",Electrical))



# QUANTITATIVE VARIABLES

#dtest %>% 
#  mutate_all(.funs = is.na) %>% 
#  summarize_all(.funs = sum) %>%
#  t()

#    Quantitative variables...
# LotFrontage    227  quantitative - replace NAs with 0
# MasVnrArea      15  quantitative - replace NAs with median
# BsmtFinSF1       1  quantitative - replace NAs with median
# BsmtFinSF2       1  quantitative - replace NAs with median
# BsmtUnfSF        1  quantitative - replace NAs with median
# TotalBsmtSF      1  quantitative - replace NAs with median
# GarageYrBlt     78  quantitative - replace NAs with median
# GarageCars       1  quantitative - replace NAs with 0
# BsmtFullBath     2    quantitative - replace NAs with 0
# BsmtHalfBath     2    quantitative - replace NAs with 0
# GarageArea       1    quantitative - replace NAs with median

dtest <- dtest %>%
  mutate(LotFrontage = ifelse(is.na(LotFrontage),0,LotFrontage),
         MasVnrArea = ifelse(is.na(MasVnrArea),median(MasVnrArea,na.rm=TRUE),MasVnrArea),
         BsmtFinSF1 = ifelse(is.na(BsmtFinSF1),median(BsmtFinSF1,nar.rm=TRUE),BsmtFinSF1),
         BsmtFinSF2 = ifelse(is.na(BsmtFinSF2),median(BsmtFinSF2,na.rm=TRUE),BsmtFinSF2),
         BsmtUnfSF = ifelse(is.na(BsmtUnfSF),median(BsmtUnfSF,na.rm=TRUE),BsmtUnfSF),
         TotalBsmtSF = ifelse(is.na(TotalBsmtSF),median(TotalBsmtSF,na.rm=TRUE),TotalBsmtSF),
         GarageYrBlt = ifelse(is.na(GarageYrBlt),median(GarageYrBlt,na.rm=TRUE),GarageYrBlt),
         GarageCars = ifelse(is.na(GarageCars),0,GarageCars),
         BsmtFullBath = ifelse(is.na(BsmtFullBath),0,BsmtFullBath),
         BsmtHalfBath = ifelse(is.na(BsmtHalfBath),0,BsmtHalfBath),
         GarageArea = ifelse(is.na(GarageArea),median(GarageArea,na.rm=TRUE),GarageArea))

d1 <- d1 %>%
  mutate(LotFrontage = ifelse(is.na(LotFrontage),0,LotFrontage),
         MasVnrArea = ifelse(is.na(MasVnrArea),median(MasVnrArea,na.rm=TRUE),MasVnrArea),
         BsmtFinSF1 = ifelse(is.na(BsmtFinSF1),median(BsmtFinSF1,na.rm=TRUE),BsmtFinSF1),
         BsmtFinSF2 = ifelse(is.na(BsmtFinSF2),median(BsmtFinSF2,na.rm=TRUE),BsmtFinSF2),
         BsmtUnfSF = ifelse(is.na(BsmtUnfSF),median(BsmtUnfSF,na.rm=TRUE),BsmtUnfSF),
         TotalBsmtSF = ifelse(is.na(TotalBsmtSF),median(TotalBsmtSF,na.rm=TRUE),TotalBsmtSF),
         GarageYrBlt = ifelse(is.na(GarageYrBlt),median(GarageYrBlt,na.rm=TRUE),GarageYrBlt),
         GarageCars = ifelse(is.na(GarageCars),0,GarageCars),
         BsmtFullBath = ifelse(is.na(BsmtFullBath),0,BsmtFullBath),
         BsmtHalfBath = ifelse(is.na(BsmtHalfBath),0,BsmtHalfBath),
         GarageArea = ifelse(is.na(GarageArea),median(GarageArea,na.rm=TRUE),GarageArea))

# the above strategy gets rid of all NAs except for BsmtFinSF1[661] in dtest dataset still has an NA for some reason..

dtest$BsmtFinSF1[661] = median(dtest$BsmtFinSF1,na.rm=TRUE)

#d1 %>% 
#  mutate_all(.funs = is.na) %>% 
#  summarize_all(.funs = sum) %>%
#  t()

#dtest %>% 
#  mutate_all(.funs = is.na) %>% 
#  summarize_all(.funs = sum) %>%
#  t()

head(d1$Alley)

```

### Data issue 2: factor variables

    Data modeling.  Should a variable be treated as an integer or a factor?  Example 1:  The quality variables have levels (poor, fair, average, good, excellent).  These could be represented as integers, 1 - 5. Example 2:  YearBuilt is a year, which could be treated as a factor or an integer.  Consider:  factors will create a more complicated and specific model with many f - 1 coefficients, where f is the number of factor levels. Coding factors as integers will produce just one coefficient, but assumes a linear relationship between predictor and outcome. What is at stake in this assumption?---that the relationship between predictor and outcome is constant from level to level.  There is an illustration of this issue below.


```{r}

#summary(d1)

# variables that should be treated as factors are below. 

# Right now, they are coded as factors that will each have many levels represented as distinct variables in the model. We could recode them to integers (not really sure how to do that) and in that case they would be treated as one variable per factor variable. You can give it a try if you can figure out how to do that. 

# the benefit of recoding them as integers would be fewer variables in the model, therefore higher bias but lower variance in the external dataset. As it is, models that use these variables will have lower bias but higher variance in the external dataset.

d1 <- d1 %>%
mutate(MSZoning = factor(MSZoning),
       Street = factor(Street),
       Alley = factor(Alley),
       LotShape = factor(LotShape),
       LandContour = factor(LandContour),
       Utilities = factor(Utilities),
       LotConfig = factor(LotConfig),
       LandSlope = factor(LandSlope),
       Neighborhood = factor(Neighborhood),
       Condition1 = factor(Condition1),
       Condition2 = factor(Condition2),
       BldgType = factor(BldgType),
       HouseStyle = factor(HouseStyle),
       RoofStyle = factor(RoofStyle),
       RoofMatl = factor(RoofMatl),
       Exterior1st = factor(Exterior1st),
       Exterior2nd = factor(Exterior2nd),
       MasVnrType = factor(MasVnrType),
       ExterQual = factor(ExterQual),
       ExterCond = factor(ExterCond),
       Foundation = factor(Foundation),
       BsmtQual = factor(BsmtQual),
       BsmtCond = factor(BsmtCond),
       BsmtExposure = factor(BsmtExposure),
       BsmtFinType1 = factor(BsmtFinType1),
       BsmtFinType2 = factor(BsmtFinType2),
       Heating = factor(Heating),
       CentralAir = factor(CentralAir),
       Electrical = factor(Electrical),
       KitchenQual = factor(KitchenQual),
       Functional = factor(Functional),
       FireplaceQu = factor(FireplaceQu),
       GarageType = factor(GarageType),
       GarageFinish = factor(GarageFinish),
       GarageQual = factor(GarageQual),
       GarageCond = factor(GarageCond),
       PavedDrive = factor(PavedDrive),
       PoolQC = factor(PoolQC),
       Fence = factor(Fence),
       MiscFeature = factor(MiscFeature),
       SaleType = factor(SaleType),
       SaleCondition = factor(SaleCondition),
       HeatingQC = factor(HeatingQC))

dtest <- dtest %>%
mutate(MSZoning = factor(MSZoning),
       Street = factor(Street),
       Alley = factor(Alley),
       LotShape = factor(LotShape),
       LandContour = factor(LandContour),
       Utilities = factor(Utilities),
       LotConfig = factor(LotConfig),
       LandSlope = factor(LandSlope),
       Neighborhood = factor(Neighborhood),
       Condition1 = factor(Condition1),
       Condition2 = factor(Condition2),
       BldgType = factor(BldgType),
       HouseStyle = factor(HouseStyle),
       RoofStyle = factor(RoofStyle),
       RoofMatl = factor(RoofMatl),
       Exterior1st = factor(Exterior1st),
       Exterior2nd = factor(Exterior2nd),
       MasVnrType = factor(MasVnrType),
       ExterQual = factor(ExterQual),
       ExterCond = factor(ExterCond),
       Foundation = factor(Foundation),
       BsmtQual = factor(BsmtQual),
       BsmtCond = factor(BsmtCond),
       BsmtExposure = factor(BsmtExposure),
       BsmtFinType1 = factor(BsmtFinType1),
       BsmtFinType2 = factor(BsmtFinType2),
       Heating = factor(Heating),
       CentralAir = factor(CentralAir),
       Electrical = factor(Electrical),
       KitchenQual = factor(KitchenQual),
       Functional = factor(Functional),
       FireplaceQu = factor(FireplaceQu),
       GarageType = factor(GarageType),
       GarageFinish = factor(GarageFinish),
       GarageQual = factor(GarageQual),
       GarageCond = factor(GarageCond),
       PavedDrive = factor(PavedDrive),
       PoolQC = factor(PoolQC),
       Fence = factor(Fence),
       MiscFeature = factor(MiscFeature),
       SaleType = factor(SaleType),
       SaleCondition = factor(SaleCondition),
       HeatingQC = factor(HeatingQC))


```

### Data issue 3: missing factor levels between test and train data

    + Missing factor levels. The predict() function must find exactly the same columns/factor levels in the new data as in the data used to fit the model. So if there is a factor level in the train set that is not in the test set then you will not be able to use your model to predict. Example:  YearBuilt as a factor has some levels in the train set that do not exist in the test set.  In such a case you cannot use the your model for prediction--- it will produce an error.


```{r}

count_levels <- function(x) unique(x) %>%  length


test_levels <- d1 %>%
  summarize_if(is.factor, .funs = count_levels) %>% 
  t()

train_levels <- dtest %>% 
  summarize_if(is.factor, .funs = count_levels) %>% 
  t()

data.frame(variables = row.names(test_levels),
           test_levels, 
           train_levels) %>% 
  mutate(problem = ifelse(test_levels != train_levels, "problem", "OK"))


```

### Data Issue 4: Numeric variables that are actually categories and need to be converted to factors
```{r}
#MSSubClass is the type of home and MoSold is the month it was sold, both are categorical in nature

d1 <- d1 %>%
mutate(MSSubClass = factor(MSSubClass),
       MoSold = factor(MoSold))
       
dtest <- dtest %>%
mutate(MSSubClass = factor(MSSubClass),
       MoSold = factor(MoSold))

```
###GarageArea Cleanup
```{r}

#ran into an error submitting the test file - looks like testID 2577 has an NA for Garage Area - I changed this to a 0

dtest <- dtest %>%
  mutate(GarageArea = ifelse(is.na(GarageArea), 0, GarageArea))

# Combine the square footage fields:
# Total_SQFT =  FirstFlrSF + SecondFlrSF + BsmtFinSF1 + BsmtFinSF2   <-- we did not use TotalSQFT in our submitted model

#d1 <- d1 %>%
#  mutate(Total_SQFT = (FirstFlrSF + SecondFlrSF +  BsmtFinSF1 + BsmtFinSF2))
#head(d1$Total_SQFT)
#head(dtest$Total_SQFT)

```

## Column Manipulation 
section for combining/adding/removing columns from the original dataset
```{r}
#Age = create a column to calculate the age at time of sale
#TotBath = create a column to combine bathrooms variables into a single variable

d1 <- d1 %>%
  mutate(Age = (YrSold - YearRemodAdd),
         TotBath = (FullBath + (HalfBath*.5) + BsmtFullBath + (BsmtHalfBath*.5)))

dtest <- dtest %>%
  mutate(Age = (YrSold - YearRemodAdd),
          TotBath = (FullBath + (HalfBath*.5) + BsmtFullBath + (BsmtHalfBath*.5)))

```



columns to remove/ignore
```{r}
#GrLivArea appears to be a summation of (FirstFlrSF, SecondFlrSF, LowQualFinSF)

mean(d1$GrLivArea == (d1$FirstFlrSF+d1$SecondFlrSF+d1$LowQualFinSF))
mean(dtest$GrLivArea == (dtest$FirstFlrSF+dtest$SecondFlrSF+dtest$LowQualFinSF))


```





## Alternate Models
```{r}
#Linear Regression
#lm(SalePrice ~ Neighborhood + YearBuilt + FirstFlrSF + SecondFlrSF + GarageArea, data=d1)





```


#Caret cross-validation
```{r}
# In-sample and out of sample R2 via caret linear model 

# Fit linear model: SalePrice ~ Neighborhood + YearBuilt + FirstFlrSF + SecondFlrSF + GarageArea

caret_lm <- train(SalePrice ~ Neighborhood + YearBuilt + FirstFlrSF + SecondFlrSF + GarageArea,
                  data = d1,
                   method = "lm")

caret_lm 

# This is the caret's cross-validation estimate of the model's 
# out-of-sample performance!  NOT in-sample performance.
#
# RMSE      Rsquared   MAE     
# 39076     0.7521927  24985.36

# Here is in-sample performance:

caret_lm %>% 
  summary

# Residual standard error: 37920 on 1431 degrees of freedom
# Multiple R-squared:  0.7766,	Adjusted R-squared:  0.7722

```



##Kaggle Submission
```{r}

submit_model <- lm(SalePrice ~ Neighborhood + YearBuilt + FirstFlrSF + SecondFlrSF + GarageArea, data=d1)
summary (submit_model)

# export our predictions as a .csv  

kaggle_submit <- dtest %>% 
  select(Id) %>% 
  mutate(SalePrice = predict(submit_model, newdata = dtest))

#head(kaggle_submit)

# code to write the csv file to upload in kaggle
# write.csv(kaggle_submit,"C:\\Users\\mmkmm\\Documents\\github\\kaggle_house_price\\submission.csv", row.names = FALSE)
#     <-- I cannot write to this file
# Craig/Belu - you'll need to swap out the path to write the file to your computer.  you can just save it in this section that way any of us can generate the file

#Mike - "C:\\Users\\mmkmm\\Documents\\github\\kaggle_house_price\\submission.csv"
#Craig - "C:\\????
#Belu - "c:\\????
```








