---
title: "final_project"
author: "Mike Marett, Craig Teerlink, Belu Chik"
output: html_document
---


```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(caret)

```

## Download and inspect data

```{r}

d1 <- read_csv("train.csv")
dtest <- read_csv("test.csv")

# rename the two illegally named variables 

colnames(d1) <- c("Id",            "MSSubClass",    "MSZoning" ,     "LotFrontage",   "LotArea",       "Street",        "Alley",         "LotShape", "LandContour" ,  "Utilities" ,    "LotConfig",     "LandSlope",     "Neighborhood",  "Condition1",    "Condition2",    "BldgType", "HouseStyle" ,   "OverallQual",   "OverallCond",   "YearBuilt"    , "YearRemodAdd" , "RoofStyle",     "RoofMatl",      "Exterior1st", "Exterior2nd",   "MasVnrType",    "MasVnrArea",    "ExterQual",     "ExterCond",     "Foundation",    "BsmtQual",      "BsmtCond","BsmtExposure",  "BsmtFinType1",  "BsmtFinSF1",    "BsmtFinType2",  "BsmtFinSF2",    "BsmtUnfSF",     "TotalBsmtSF" ,  "Heating", "HeatingQC",     "CentralAir" ,   "Electrical"   , "FirstFlrSF" ,     "SecondFlrSF" ,     "LowQualFinSF",  "GrLivArea",     "BsmtFullBath",  "BsmtHalfBath",  "FullBath",      "HalfBath",      "BedroomAbvGr",  "KitchenAbvGr",  "KitchenQual",   "TotRmsAbvGrd",  "Functional",   
"Fireplaces",    "FireplaceQu",   "GarageType",    "GarageYrBlt",   "GarageFinish",  "GarageCars",    "GarageArea",    "GarageQual",   
"GarageCond",    "PavedDrive",    "WoodDeckSF",    "OpenPorchSF",   "EnclosedPorch", "3SsnPorch",     "ScreenPorch",   "PoolArea",      "PoolQC",        "Fence"       ,  "MiscFeature",   "MiscVal"     ,  "MoSold"  ,      "YrSold"  ,      "SaleType"    ,  "SaleCondition", "SalePrice")

# same thing for dtest (minus sales price)

colnames(dtest) <- c("Id",            "MSSubClass",    "MSZoning" ,     "LotFrontage",   "LotArea",       "Street",        "Alley",         "LotShape", "LandContour" ,  "Utilities" ,    "LotConfig",     "LandSlope",     "Neighborhood",  "Condition1",    "Condition2",    "BldgType", "HouseStyle" ,   "OverallQual",   "OverallCond",   "YearBuilt"    , "YearRemodAdd" , "RoofStyle",     "RoofMatl",      "Exterior1st", "Exterior2nd",   "MasVnrType",    "MasVnrArea",    "ExterQual",     "ExterCond",     "Foundation",    "BsmtQual",      "BsmtCond","BsmtExposure",  "BsmtFinType1",  "BsmtFinSF1",    "BsmtFinType2",  "BsmtFinSF2",    "BsmtUnfSF",     "TotalBsmtSF" ,  "Heating", "HeatingQC",     "CentralAir" ,   "Electrical"   , "FirstFlrSF" ,     "SecondFlrSF" ,     "LowQualFinSF",  "GrLivArea",     "BsmtFullBath",  "BsmtHalfBath",  "FullBath",      "HalfBath",      "BedroomAbvGr",  "KitchenAbvGr",  "KitchenQual",   "TotRmsAbvGrd",  "Functional",   
"Fireplaces",    "FireplaceQu",   "GarageType",    "GarageYrBlt",   "GarageFinish",  "GarageCars",    "GarageArea",    "GarageQual",   
"GarageCond",    "PavedDrive",    "WoodDeckSF",    "OpenPorchSF",   "EnclosedPorch", "3SsnPorch",     "ScreenPorch",   "PoolArea",      "PoolQC",        "Fence"       ,  "MiscFeature",   "MiscVal"     ,  "MoSold"  ,      "YrSold"  ,      "SaleType"    ,  "SaleCondition")

#colnames(d1) == colnames(dtest)

```

## Code used for the interim report 

#GarageArea Cleanup
```{r}

#ran into an error submitting the test file - looks like testID 2577 has an NA for Garage Area - I changed this to a 0

dtest <- dtest %>%
  mutate(GarageArea = ifelse(is.na(GarageArea), 0, GarageArea))

# Combine the square footage fields:
# Total_SQFT =  FirstFlrSF + SecondFlrSF + BsmtFinSF1 + BsmtFinSF2   <-- we did not use TotalSQFT in our submitted model

#d1 <- d1 %>%
#  mutate(Total_SQFT = (FirstFlrSF + SecondFlrSF +  BsmtFinSF1 + BsmtFinSF2))
#head(d1$Total_SQFT)
#head(dtest$Total_SQFT)

submit_model <- lm(SalePrice ~ Neighborhood + YearBuilt + FirstFlrSF + SecondFlrSF + GarageArea, data=d1)
summary (submit_model)

# export our predictions as a .csv  

kaggle_submit <- dtest %>% 
  select(Id) %>% 
  mutate(SalePrice = predict(submit_model, newdata = dtest))

#head(kaggle_submit)

#write.csv(kaggle_submit,"C:\\Users\\mmkmm\\Documents\\github\\kaggle_house_price\\submission.csv", row.names = FALSE)
#     <-- I cannot write to this file

#Mike - "C:\\Users\\mmkmm\\Documents\\github\\kaggle_house_price\\submission.csv"

# In-sample and out of sample R2 via caret linear model 

# Fit linear model: SalePrice ~ Neighborhood + YearBuilt + FirstFlrSF + SecondFlrSF + GarageArea

caret_lm <- train(SalePrice ~ Neighborhood + YearBuilt + FirstFlrSF + SecondFlrSF + GarageArea,
                  data = d1,
                   method = "lm")

caret_lm 

# This is the caret's cross-validation estimate of the model's 
# out-of-sample performance!  NOT in-sample performance.
#
# RMSE      Rsquared   MAE     
# 39076     0.7521927  24985.36

# Here is in-sample performance:

caret_lm %>% 
  summary

# Residual standard error: 37920 on 1431 degrees of freedom
# Multiple R-squared:  0.7766,	Adjusted R-squared:  0.7722

```

## Data issue 1: NAs 

    + NAs.  If there are missing values among the test set predictors, predict() will produce an NA.  Kaggle won't like that! *Stop and think*:  have you coded the NAs appropriately? For example, `alley` has a bunch of NAs, but in that case NA does not mean missing data but instead means: no alley.  The appropriate action is to recode NAs in `alley` as "none."

```{r}

# show NA counts for all variables 

dtest %>% 
  mutate_all(.funs = is.na) %>% 
  summarize_all(.funs = sum) %>%
  t()

# Decisions...
# 
# LotFrontage:   227  replace NAs with 0
# Alley:        1352  replace NAs with 0
# Utilities:       2  replace NAs with median
# Exterior1st:     1  replace NAs with median (is this a factor or continuous RV?)
# Exterior2nd:     1  replace NAs with median (is this a factor or continuous RV?)
# MasVnrType:     16  
# MasVnrArea:     15  
# BsmtQual        44
# BsmtCond        45
# BsmtExposure    44
# BsmtFinType1    42
# BsmtFinSF1       1
# BsmtFinType2    42
# BsmtFinSF2       1
# BsmtUnfSF        1
# TotalBsmtSF      1
# KitchenQual      1
# Functional       2
# FireplaceQu    730
# GarageType      76
# GarageYrBlt     78
# GarageFinish    78
# GarageCars       1
# GarageQual      78
# GarageCond      78
# PoolQC        1456
# Fence         1169
# MiscFeature   1408
# SaleType         1

```

## Data issue 2: factor variables

    Data modeling.  Should a variable be treated as an integer or a factor?  Example 1:  The quality variables have levels (poor, fair, average, good, excellent).  These could be represented as integers, 1 - 5. Example 2:  YearBuilt is a year, which could be treated as a factor or an integer.  Consider:  factors will create a more complicated and specific model with many f - 1 coefficients, where f is the number of factor levels. Coding factors as integers will produce just one coefficient, but assumes a linear relationship between predictor and outcome. What is at stake in this assumption?---that the relationship between predictor and outcome is constant from level to level.  There is an illustration of this issue below.

```{r}



```

## Data issue 3: missing factor levels between test and train data

    + Missing factor levels. The predict() function must find exactly the same columns/factor levels in the new data as in the data used to fit the model. So if there is a factor level in the train set that is not in the test set then you will not be able to use your model to predict. Example:  YearBuilt as a factor has some levels in the train set that do not exist in the test set.  In such a case you cannot use the your model for prediction--- it will produce an error.


```{r}



```

## Factor levels in categorical predictors

Check factor levels for Neighborhood in test and train.

```{r}

factor(train$Neighborhood) %>% levels
```

```{r}
factor(test$Neighborhood) %>% levels

```

They appear to be the same.  For contrast, check factor levels in YearBuilt.

```{r}
factor(train$YearBuilt) %>% levels
```

```{r}

factor(test$YearBuilt) %>% levels
```

Different! Some of the test levels are not in train and vice versa.

This will prevent a model developed with the train set from using the test set to predict.  Observe:

```{r}
(yrbuilt_model <- lm(SalePrice ~ factor(YearBuilt), data = train)) %>% 
  summary

predict(yrbuilt_model, newdata = test)
```

It is possible to fix this problem by manually setting the levels in test to match those in train.

```{r}
test$YearBuilt <- factor(test$YearBuilt, levels = c(factor(train$YearBuilt) %>% levels))

predict(yrbuilt_model, newdata = test) %>% 
  head

```












# some plots for after interim report

```{r}

#plot SalePrice by 1st floor square feet

ggplot(train, aes(FirstFlrSF, SalePrice)) +
  geom_point() +
  theme_minimal() +
  stat_smooth(method="lm", se = F) +
  labs(title = "price ~ 1st floor sqft")

```

```{r}

#plot SalePrice by 2nd floor square feet

ggplot(train, aes(SecondFlrSF, SalePrice)) +
  geom_point() +
  theme_minimal() +
  stat_smooth(method="lm", se = F) +
  labs(title = "price ~ 2nd floor sqft")

# THIS VARIABLE IS WEIRD...LOTS OF ZEROES

```

```{r}

#plot SalePrice by YearBuilt...not sure how to make this plot

ggplot(train, aes(SalePrice)) +
  geom_boxplot()+


```
